# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Commands

```bash
# Development (run all services)
npm run dev:all          # Supabase + Next.js + Inngest + Stripe in parallel

# Individual services
npm run dev              # Next.js dev server (http://localhost:3000)
npm run dev:inngest      # Inngest Dev Server (job queue UI + worker)
npm run dev:stripe       # Stripe CLI webhook forwarding to localhost:3000
npm run dev:supabase     # Local Supabase via Docker

# Database
npm run db:reset         # Apply all migrations to local Supabase

# Production
npm run build && npm run start

# Lint
npm run lint             # ESLint v9
```

No test framework is configured.

## Architecture Overview

**Storybook Dreams** is a Next.js 16 (App Router) application that converts user character descriptions into 20-page AI-generated coloring book PDFs using a fully automated pipeline.

### Payment-First Order Flow

1. User describes character → `createOrderForPreview()` server action → order created (`status: pending_payment`)
2. 3 Flux preview images generated and persisted to Supabase Storage
3. User selects preview + tier + completes Stripe checkout
4. Stripe webhook (`/api/webhook/stripe`) verifies signature, updates order, fires **Inngest event**
5. Inngest durable function runs the full book generation pipeline

### Inngest Pipeline (`src/lib/inngest/functions/generate-book.ts`)

Two fully idempotent steps (safe to retry):

**Step 1 — Manifest Generation:**
- LLM (`gpt-4o-mini` or `gpt-4o`) transforms user input into a structured `CharacterManifest` (Zod-validated)
- Generates 3 body poses + 20 scene descriptions
- Inserts `character_manifests` and `pages` rows (`status: pending`)

**Step 2 — Image Generation Loop:**
- For each pending page: Flux Kontext Pro (img2img with reference preview) → quality gate (GPT-4o vision) → if fails, critic feedback refines prompt, retry (max 2)
- Safety check: reject if `lineArtScore ≤ 2`
- After all pages: assemble PDF with `pdf-lib` → upload to Supabase Storage → mark order `complete`

### Key Architectural Decisions

**Prompt Engineering for Flux.1:**
- Line-art mandate front-loaded (Flux front-weights early tokens): "Black ink outlines on white paper only. No shading, no color, no gray."
- No color adjectives in scene descriptions ("patterned" not "colorful")
- Narrative prose beats keyword lists for Flux

**Image Persistence:**
Replicate CDN URLs expire in ~24h. All images are immediately fetched and re-uploaded to Supabase Storage (`character-previews/{orderId}/` and `coloring-books/{orderId}.pdf`).

**Data URI Workaround (local dev):**
For Inngest workers, Replicate URLs are fetched → base64 data URIs to avoid `127.0.0.1` access issues from the worker context.

**Tiered AI Models:**
- Standard tier (≤$12): `gpt-4o-mini` everywhere
- Premium tier (≥$25): `gpt-4o-mini` for low-complexity, `gpt-4o` for high-complexity
- Controlled via env vars `AI_MODEL_MANIFEST` and `AI_MODEL_COMPLEX`

**Quality Gate:**
GPT-4o vision scores each generated image on 5 dimensions (1–5): line art purity, background richness, anatomy, hands, composition. Passes if: `lineArt ≥ 4 && background ≥ 3 && anatomy ≥ 3 && composition ≥ 3`.

### Database Schema (Supabase PostgreSQL)

Three core tables:
- **`orders`** — Stripe session, email, status lifecycle, user input (JSONB), preview images (JSONB array), PDF URL, price tier
- **`character_manifests`** — Structured character data generated by LLM (linked 1:1 to order)
- **`pages`** — One row per coloring page (1–20), tracks generation status, scene description, full prompt, image URL

Order status lifecycle: `pending_payment` → `pending` → `manifest_generated` → `generating` → `complete` | `failed`

### Key Files

| File | Purpose |
|------|---------|
| `src/app/(marketing)/actions.ts` | Server actions: preview generation, Stripe checkout creation |
| `src/app/(dashboard)/orders/[id]/auto-refresh.tsx` | Client component polling order status |
| `src/lib/inngest/functions/generate-book.ts` | Main durable workflow (manifest + image generation) |
| `src/lib/ai/generate-manifest.ts` | LLM → CharacterManifest (Zod structured output) |
| `src/lib/ai/generate-pages.ts` | Scene generation, pose palette, prompt composition |
| `src/lib/ai/quality-gate.ts` | GPT-4o vision scoring + critic feedback |
| `src/lib/ai/client.ts` | Replicate API wrappers (Flux Dev, Kontext Pro, Canny) |
| `src/lib/utils/pdf.ts` | PDF assembly (pdf-lib) + Supabase Storage upload |
| `src/lib/utils/images.ts` | Replicate CDN → Supabase Storage persistence |
| `src/lib/supabase/queries.ts` | All SQL CRUD (orders, manifests, pages, library purchases, credits) |
| `src/types/manifest.ts` | `CharacterManifest` Zod schema (source of truth for AI output shape) |
| `src/app/(marketing)/library/page.tsx` | Public character library — search, filter, grid |
| `src/app/(marketing)/library/[orderId]/page.tsx` | Character detail — 20-page mix selection |
| `src/app/(marketing)/library/checkout/page.tsx` | Library checkout (Stripe or credits) |
| `src/app/(marketing)/library/download/[purchaseId]/page.tsx` | Download page — polls until PDF ready |
| `src/app/(marketing)/library/credits/page.tsx` | Buy credit packs |
| `src/app/(marketing)/library/actions.ts` | Library checkout, credit redemption server actions |
| `src/lib/inngest/functions/assemble-library-book.ts` | Inngest: assemble mix-and-match PDF |
| `src/components/library/mix-match-cart.tsx` | Cart context + localStorage persistence |

### Credit Economy
Credits are library-only currency. 1 credit = 1 page in a mix-and-match library purchase.
Credits have no cash value and cannot be redeemed for money.
Creator earnings (1 credit per page downloaded) accumulate in their balance and can be spent on future library purchases.

### Design Consistency

All new UI components must match the **Storybook Dreams** visual theme:
- Before building any new component, read `src/components/checkout-form.tsx` and `src/components/gallery-of-dreams.tsx` to understand the color palette, typography scale, Tailwind class patterns, and sketchbook/hand-drawn aesthetic
- Reuse existing primitives from `src/components/ui/` before creating new ones
- New pages under `/library/` must use the `(marketing)` layout shell so navbar, footer, and background remain consistent

### Path Aliases

`@/*` maps to `./src/*`

### Full Local Stack Setup

See `docs/LOCAL_FULL_STACK.md` for step-by-step instructions. Requires Docker (for Supabase), Stripe CLI, and all env vars in `.env.local`. Test payments use Stripe card `4242 4242 4242 4242` or a 100% off coupon.

Use subagents to investigate how our authentication system handles token
refresh, and whether we have any existing OAuth utilities I should reuse.
